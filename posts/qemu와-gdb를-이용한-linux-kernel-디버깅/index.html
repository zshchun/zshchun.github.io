<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>QEMU와 GDB를 이용한 Linux Kernel 디버깅 | sh</title>
<meta name=keywords content="gdb,linux kernel,qemu"><meta name=description content="Linux kernel를 디버깅 하는 방법으로 QEMU와 JTAG을 이용한"><meta name=author content="Seunghwan Chun"><link rel=canonical href=https://zshchun.github.io/posts/qemu%EC%99%80-gdb%EB%A5%BC-%EC%9D%B4%EC%9A%A9%ED%95%9C-linux-kernel-%EB%94%94%EB%B2%84%EA%B9%85/><link crossorigin=anonymous href=/assets/css/stylesheet.23067b1091b46f25fb142b66e5937f4faa99f4906ab8e83ae91ac794a53b03a5.css integrity="sha256-IwZ7EJG0byX7FCtm5ZN/T6qZ9JBquOg66RrHlKU7A6U=" rel="preload stylesheet" as=style><link rel=icon href=https://zshchun.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://zshchun.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://zshchun.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://zshchun.github.io/apple-touch-icon.png><link rel=mask-icon href=https://zshchun.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-228892904-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"))</script><meta property="og:title" content="QEMU와 GDB를 이용한 Linux Kernel 디버깅"><meta property="og:description" content="Linux kernel를 디버깅 하는 방법으로 QEMU와 JTAG을 이용한"><meta property="og:type" content="article"><meta property="og:url" content="https://zshchun.github.io/posts/qemu%EC%99%80-gdb%EB%A5%BC-%EC%9D%B4%EC%9A%A9%ED%95%9C-linux-kernel-%EB%94%94%EB%B2%84%EA%B9%85/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-09-18T01:11:34+09:00"><meta property="article:modified_time" content="2022-09-18T01:11:34+09:00"><meta property="og:site_name" content="sh"><meta name=twitter:card content="summary"><meta name=twitter:title content="QEMU와 GDB를 이용한 Linux Kernel 디버깅"><meta name=twitter:description content="Linux kernel를 디버깅 하는 방법으로 QEMU와 JTAG을 이용한"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://zshchun.github.io/posts/"},{"@type":"ListItem","position":2,"name":"QEMU와 GDB를 이용한 Linux Kernel 디버깅","item":"https://zshchun.github.io/posts/qemu%EC%99%80-gdb%EB%A5%BC-%EC%9D%B4%EC%9A%A9%ED%95%9C-linux-kernel-%EB%94%94%EB%B2%84%EA%B9%85/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"QEMU와 GDB를 이용한 Linux Kernel 디버깅","name":"QEMU와 GDB를 이용한 Linux Kernel 디버깅","description":"Linux kernel를 디버깅 하는 방법으로 QEMU와 JTAG을 이용한","keywords":["gdb","linux kernel","qemu"],"articleBody":"Linux kernel를 디버깅 하는 방법으로 QEMU와 JTAG을 이용한 방법 등이 있다.\n여기서는 x86 64비트 환경에서 QEMU와 gdb로 디버깅 하는 방법을 설명한다.\n패키지 설치 먼저 gdb, qemu 등 패키지들을 설치한다.\nUbuntu의 경우 다음 명령을 실행한다.\n$ sudo apt install gdb qemu-system-x86 curl git libncurses5-dev build-essential libssl-dev bc flex bison libelf-dev Linux kernel 다운로드 Linux kernel 빌드를 위해 kernel.org 또는 github 에서 소스 코드를 다운로드 받는다.\n$ git clone git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git Linux kernel 설정 Linux 기본 설정파일을 세팅하고 kvm 가속 설정을 한다.\n디버깅에 필요한 디버깅 심볼과 GDB용 스크립트를 설정한다.\n$ cd linux $ make defconfig $ make kvm_guest.config $ sed -i 's/^# CONFIG_DEBUG_INFO is not set/CONFIG_DEBUG_INFO=y/' .config $ sed -i 's/^CONFIG_DEBUG_INFO_NONE=y/CONFIG_DEBUG_INFO=y\\n# CONFIG_DEBUG_INFO_NONE is not set/' .config $ sed -i 's/^# CONFIG_DEBUG_INFO_DWARF_TOOLCHAIN_DEFAULT is not set/CONFIG_DEBUG_INFO_DWARF_TOOLCHAIN_DEFAULT=y/' .config $ echo CONFIG_GDB_SCRIPTS=y \u003e\u003e .config $ make olddefconfig 커널 빌드 및 bzImage 복사 커널 이미지를 빌드한다.\n$ make -j`nproc` arch/x86_64/boot/bzImage : 심볼이 제거된 커널 이미지 vmlinux : 디버깅 심볼이 있는 커널 이미지 Ubuntu 다운로드 정상적으로 부팅해 shell까지 실행하려면 리눅스 배포판이 필요하다. ISO 설치 이미지로 배포판을 설치하거나 미리 설치된 이미지를 다운로드한다.\n여기서는 Ubuntu 이미지를 다운로드 받아 사용한다. Ubuntu cloud 등에서 이미지를 받으면 설치 시간을 단축할 수 있다.\n$ curl https://cloud-images.ubuntu.com/jammy/current/jammy-server-cloudimg-amd64.img -o ubuntu.img Linux kernel 디버깅 QEMU를 실행한다. -s와 -S 옵션 때문에 gdb 포트 1234를 열어둔 상태로 멈춰있다.\n$ qemu-system-x86_64 -smp 2 -m 512M -kernel $PWD/arch/x86/boot/bzImage -serial mon:stdio -append \"root=/dev/sda1 console=ttyS0,115200 nokaslr\" -drive file=ubuntu.img,index=0 -device e1000,netdev=net0 -netdev user,id=net0 -nographic -s -S GDB를 연결하고 심볼들을 로드한다.\n$ gdb (gdb) set auto-load safe-path . (gdb) add-auto-load-safe-path . (gdb) file vmlinux Reading symbols from vmlinux... (gdb) target remote localhost:1234 Remote debugging using localhost:1234 0x000000000000fff0 in exception_stacks () (gdb) break start_kernel Breakpoint 1 at 0xffffffff82fb8c19: file init/main.c, line 930. (gdb) continue ... lx-iomem : IO 메모리를 보여준다. lx-cpus : cpu 상태를 보여준다. lx-ps : 현재 프로세스를 보여준다. lx-cmdline : cmdline 을 보여준다. lx-dmesg : 커널 메세지를 보여준다. 기타 -cpu host -accel kvm 명령어로 kvm 활성화하면 빠르다. 하지만 break가 안되서 hbreak를 사용해야 한다. storage와 network를 virtio 등으로 로드하면 조금 더 빠른 설정이 가능하다. Ubuntu cloud 이미지를 실행하면 일부 설정 에러 메세지가 뜬다. cloud-util과 cloud-config로 초기화하면 에러메세지를 없앨수 있다. QEMU의 console 단축키는 Ctrl-a c 다. quit 명령어로 종료가 가능하다. References https://www.kernel.org/doc/html/v5.19/dev-tools/gdb-kernel-debugging.html\n","wordCount":"787","inLanguage":"en","datePublished":"2022-09-18T01:11:34+09:00","dateModified":"2022-09-18T01:11:34+09:00","author":{"@type":"Person","name":"Seunghwan Chun"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://zshchun.github.io/posts/qemu%EC%99%80-gdb%EB%A5%BC-%EC%9D%B4%EC%9A%A9%ED%95%9C-linux-kernel-%EB%94%94%EB%B2%84%EA%B9%85/"},"publisher":{"@type":"Organization","name":"sh","logo":{"@type":"ImageObject","url":"https://zshchun.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://zshchun.github.io/ accesskey=h title="Home (Alt + H)">Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://zshchun.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://zshchun.github.io/docs/ title=docs><span>docs</span></a></li><li><a href=https://zshchun.github.io/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://zshchun.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://zshchun.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">QEMU와 GDB를 이용한 Linux Kernel 디버깅</h1><div class=post-meta><span title='2022-09-18 01:11:34 +0900 KST'>2022/09/18</span>&nbsp;·&nbsp;787 words&nbsp;·&nbsp;Seunghwan Chun</div></header><div class=post-content><p>Linux kernel를 디버깅 하는 방법으로 QEMU와 JTAG을 이용한 방법 등이 있다.</p><p>여기서는 x86 64비트 환경에서 QEMU와 gdb로 디버깅 하는 방법을 설명한다.</p><h2 id=패키지-설치>패키지 설치<a hidden class=anchor aria-hidden=true href=#패키지-설치>#</a></h2><p>먼저 gdb, qemu 등 패키지들을 설치한다.</p><p>Ubuntu의 경우 다음 명령을 실행한다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=display:flex><span>$ sudo apt install gdb qemu-system-x86 curl git libncurses5-dev build-essential libssl-dev bc flex bison libelf-dev
</span></span></code></pre></div><h2 id=linux-kernel-다운로드>Linux kernel 다운로드<a hidden class=anchor aria-hidden=true href=#linux-kernel-다운로드>#</a></h2><p>Linux kernel 빌드를 위해 <a href=https://kernel.org/>kernel.org</a> 또는 <a href=https://github.com/torvalds/linux>github</a> 에서 소스 코드를 다운로드 받는다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=display:flex><span>$ git clone git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git
</span></span></code></pre></div><h2 id=linux-kernel-설정>Linux kernel 설정<a hidden class=anchor aria-hidden=true href=#linux-kernel-설정>#</a></h2><p>Linux 기본 설정파일을 세팅하고 kvm 가속 설정을 한다.</p><p>디버깅에 필요한 디버깅 심볼과 GDB용 스크립트를 설정한다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=display:flex><span>$ cd linux
</span></span><span style=display:flex><span>$ make defconfig
</span></span><span style=display:flex><span>$ make kvm_guest.config
</span></span><span style=display:flex><span>$ sed -i <span style=color:#e6db74>&#39;s/^# CONFIG_DEBUG_INFO is not set/CONFIG_DEBUG_INFO=y/&#39;</span> .config
</span></span><span style=display:flex><span>$ sed -i <span style=color:#e6db74>&#39;s/^CONFIG_DEBUG_INFO_NONE=y/CONFIG_DEBUG_INFO=y\n# CONFIG_DEBUG_INFO_NONE is not set/&#39;</span> .config
</span></span><span style=display:flex><span>$ sed -i <span style=color:#e6db74>&#39;s/^# CONFIG_DEBUG_INFO_DWARF_TOOLCHAIN_DEFAULT is not set/CONFIG_DEBUG_INFO_DWARF_TOOLCHAIN_DEFAULT=y/&#39;</span> .config
</span></span><span style=display:flex><span>$ echo CONFIG_GDB_SCRIPTS<span style=color:#f92672>=</span>y &gt;&gt; .config
</span></span><span style=display:flex><span>$ make olddefconfig
</span></span></code></pre></div><h2 id=커널-빌드-및-bzimage-복사>커널 빌드 및 bzImage 복사<a hidden class=anchor aria-hidden=true href=#커널-빌드-및-bzimage-복사>#</a></h2><p>커널 이미지를 빌드한다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=display:flex><span>$ make -j<span style=color:#e6db74>`</span>nproc<span style=color:#e6db74>`</span>
</span></span></code></pre></div><ul><li>arch/x86_64/boot/bzImage : 심볼이 제거된 커널 이미지</li><li>vmlinux : 디버깅 심볼이 있는 커널 이미지</li></ul><h2 id=ubuntu-다운로드>Ubuntu 다운로드<a hidden class=anchor aria-hidden=true href=#ubuntu-다운로드>#</a></h2><p>정상적으로 부팅해 shell까지 실행하려면 리눅스 배포판이 필요하다. ISO 설치 이미지로 배포판을 설치하거나 미리 설치된 이미지를 다운로드한다.</p><p>여기서는 Ubuntu 이미지를 다운로드 받아 사용한다. <a href=https://cloud-images.ubuntu.com/>Ubuntu cloud</a> 등에서 이미지를 받으면 설치 시간을 단축할 수 있다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=display:flex><span>$ curl https://cloud-images.ubuntu.com/jammy/current/jammy-server-cloudimg-amd64.img -o ubuntu.img
</span></span></code></pre></div><h2 id=linux-kernel-디버깅>Linux kernel 디버깅<a hidden class=anchor aria-hidden=true href=#linux-kernel-디버깅>#</a></h2><p>QEMU를 실행한다. -s와 -S 옵션 때문에 gdb 포트 1234를 열어둔 상태로 멈춰있다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=display:flex><span>$ qemu-system-x86_64 -smp <span style=color:#ae81ff>2</span> -m 512M -kernel $PWD/arch/x86/boot/bzImage -serial mon:stdio -append <span style=color:#e6db74>&#34;root=/dev/sda1 console=ttyS0,115200 nokaslr&#34;</span> -drive file<span style=color:#f92672>=</span>ubuntu.img,index<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> -device e1000,netdev<span style=color:#f92672>=</span>net0 -netdev user,id<span style=color:#f92672>=</span>net0 -nographic -s -S
</span></span></code></pre></div><p>GDB를 연결하고 심볼들을 로드한다.</p><pre tabindex=0><code>$ gdb
(gdb) set auto-load safe-path .
(gdb) add-auto-load-safe-path .
(gdb) file vmlinux
Reading symbols from vmlinux...
(gdb) target remote localhost:1234
Remote debugging using localhost:1234
0x000000000000fff0 in exception_stacks ()
(gdb) break start_kernel
Breakpoint 1 at 0xffffffff82fb8c19: file init/main.c, line 930.
(gdb) continue
...
</code></pre><ul><li>lx-iomem : IO 메모리를 보여준다.</li><li>lx-cpus : cpu 상태를 보여준다.</li><li>lx-ps : 현재 프로세스를 보여준다.</li><li>lx-cmdline : cmdline 을 보여준다.</li><li>lx-dmesg : 커널 메세지를 보여준다.</li></ul><h2 id=기타>기타<a hidden class=anchor aria-hidden=true href=#기타>#</a></h2><ul><li>-cpu host -accel kvm 명령어로 kvm 활성화하면 빠르다. 하지만 break가 안되서 hbreak를 사용해야 한다.</li><li>storage와 network를 virtio 등으로 로드하면 조금 더 빠른 설정이 가능하다.</li><li>Ubuntu cloud 이미지를 실행하면 일부 설정 에러 메세지가 뜬다. cloud-util과 cloud-config로 초기화하면 에러메세지를 없앨수 있다.</li><li>QEMU의 console 단축키는 Ctrl-a c 다. quit 명령어로 종료가 가능하다.</li></ul><h2 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h2><p><a href=https://www.kernel.org/doc/html/v5.19/dev-tools/gdb-kernel-debugging.html>https://www.kernel.org/doc/html/v5.19/dev-tools/gdb-kernel-debugging.html</a></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://zshchun.github.io/tags/gdb/>gdb</a></li><li><a href=https://zshchun.github.io/tags/linux-kernel/>linux kernel</a></li><li><a href=https://zshchun.github.io/tags/qemu/>qemu</a></li></ul><nav class=paginav><a class=prev href=https://zshchun.github.io/posts/%EC%95%94%ED%98%B8%ED%99%94%EB%90%9C-%ED%8C%8C%EC%9D%BC%EC%9D%98-%ED%8C%90%EB%B3%84/><span class=title>« Prev</span><br><span>암호화된 파일의 판별</span>
</a><a class=next href=https://zshchun.github.io/posts/git%EC%97%90-commit%EC%8B%9C-%EC%9E%90%EB%8F%99%EC%9C%BC%EB%A1%9C-%EB%A9%94%EC%84%B8%EC%A7%80-%EC%B6%94%EA%B0%80%ED%95%98%EA%B8%B0/><span class=title>Next »</span><br><span>Git에 commit시 자동으로 메세지 추가하기</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://zshchun.github.io/>sh</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>