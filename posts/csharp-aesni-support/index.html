<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>NET의 AES HW 가속 지원 | sh</title><meta name=keywords content="c#,crypto"><meta name=description content="목적 AES 대칭키 알고리즘은 아키텍처에서 AES-NI와 같은 HW 가속 instruction"><meta name=author content="Seunghwan Chun"><link rel=canonical href=https://zshchun.github.io/posts/csharp-aesni-support/><link crossorigin=anonymous href=/assets/css/stylesheet.0d2ee8bb1bc6a8196da0f4036d74cedc1fb80d74ab9f6160fc44670f9b85dd9c.css integrity="sha256-DS7ouxvGqBltoPQDbXTO3B+4DXSrn2Fg/ERnD5uF3Zw=" rel="preload stylesheet" as=style><link rel=icon href=https://zshchun.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://zshchun.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://zshchun.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://zshchun.github.io/apple-touch-icon.png><link rel=mask-icon href=https://zshchun.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-228892904-1","auto"),ga("send","pageview"))</script><meta property="og:title" content="NET의 AES HW 가속 지원"><meta property="og:description" content="목적 AES 대칭키 알고리즘은 아키텍처에서 AES-NI와 같은 HW 가속 instruction"><meta property="og:type" content="article"><meta property="og:url" content="https://zshchun.github.io/posts/csharp-aesni-support/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-03-03T01:24:30+09:00"><meta property="article:modified_time" content="2022-03-03T01:24:30+09:00"><meta property="og:site_name" content="sh"><meta name=twitter:card content="summary"><meta name=twitter:title content="NET의 AES HW 가속 지원"><meta name=twitter:description content="목적 AES 대칭키 알고리즘은 아키텍처에서 AES-NI와 같은 HW 가속 instruction"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://zshchun.github.io/posts/"},{"@type":"ListItem","position":2,"name":"NET의 AES HW 가속 지원","item":"https://zshchun.github.io/posts/csharp-aesni-support/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"NET의 AES HW 가속 지원","name":"NET의 AES HW 가속 지원","description":"목적 AES 대칭키 알고리즘은 아키텍처에서 AES-NI와 같은 HW 가속 instruction","keywords":["c#","crypto"],"articleBody":"목적 AES 대칭키 알고리즘은 아키텍처에서 AES-NI와 같은 HW 가속 instruction set을 제공하기도 한다.\n라이브러리에서 AES 가속을 지원한다면 프로그램의 수행속도를 줄일 수 있다.\n검색 결과 AesManaged는 AES HW 가속을 지원하고 AesCryptoServiceProvider 클래스는 AES 가속을 지원하지 않는 것을 확인해 확인하기 위해 간단한 테스트를 하였다.\n가설 AES의 HW 가속은 순수 SW 연산보다 현저히 빠를 것이다. .NET에서 AesCryptoServiceProvider class는 HW 가속을 지원하며 AesManaged class는 지원하지 않을 것이다. 작은 크기의 많은 AES 연산에서는 overhead로 HW 가속이 더 느릴수 있다. .NET 4.8, 4KB x 100000 AES encryption 작은 크기에 큰 반복 횟수에서는 AesManaged가 더 빠른 결과를 보였다.\n.NET 4.8 1(ms) 2 3 4 5 AesManaged 4968 4940 4947 4971 4939 AesCryptoServiceProvider 6395 6407 6399 6323 6322 .NET 4.8, 1MB x 1000 AES encryption 큰 크기에 낮은 반복 횟수의 암호화는 AES 가속이 되는 AesCryptoServiceProvider 클래스가 월등히 유리하다. 클래스만 변경했을 때 12배 이상 차이가 나는 것을 확인했다.\n.NET 4.8 1(ms) 2 3 4 5 AesCryptoServiceProvider 1004 983 984 987 984 AesManaged 12468 12671 12436 12483 12436 Code Linux \u0026 OpenSSL 리눅스 에서는 openssl cli로 HW 가속을 테스트할 수 있다.\n가능한 경우 EVP_ 접두사 함수들은 기본적으로 AES-NI 를 사용하며 AES_ 접두사 함수들은 사용하지 않는다.\n64바이트 이상에서 속도가 3배 이상 차이나는 것을 확인할 수 있다.\n1$ openssl speed -elapsed -evp aes-128-cbc 2type 16 bytes 64 bytes 256 bytes 1024 bytes 8192 bytes 16384 bytes 3aes-128-cbc 879157.61k 1346181.01k 1409330.52k 1448567.47k 1479671.81k 1460371.46k 4 5$ OPENSSL_ia32cap=\"~0x200000200000000\" openssl speed -elapsed -evp aes-128-cbc 6type 16 bytes 64 bytes 256 bytes 1024 bytes 8192 bytes 16384 bytes 7aes-128-cbc 409826.10k 425150.51k 428506.71k 429743.79k 429782.36k 429725.01k 결론 .NET 4.8 에서는 AesCryptoServiceProvider 쪽을 사용하는 것이 대개의 경우 더 유리하다. .NET 6.0도 테스트했지만 두 클래스의 속도가 400-600ms로 비슷한 결과가 나왔다. 6.0에서는 AesCryptoServiceProvider 클래스도 HW 가속을 지원하는 것이 아닐까 추측한다. References https://www.codeproject.com/Tips/844795/Measuring-the-performance-of-AES-implementations-i https://odetocode.com/blogs/scott/archive/2014/02/24/symmetric-encryption-benchmarks-with-c.aspx https://stackoverflow.com/questions/23444135/is-net-aesmanaged-cryptography-hardware-accelerated https://stackoverflow.com/questions/25284119/how-can-i-check-if-openssl-is-support-use-the-intel-aes-ni ","wordCount":"628","inLanguage":"en","datePublished":"2022-03-03T01:24:30+09:00","dateModified":"2022-03-03T01:24:30+09:00","author":{"@type":"Person","name":"Seunghwan Chun"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://zshchun.github.io/posts/csharp-aesni-support/"},"publisher":{"@type":"Organization","name":"sh","logo":{"@type":"ImageObject","url":"https://zshchun.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://zshchun.github.io/ accesskey=h title="Home (Alt + H)">Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://zshchun.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://zshchun.github.io/docs/ title=docs><span>docs</span></a></li><li><a href=https://zshchun.github.io/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://zshchun.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://zshchun.github.io/posts/>Posts</a></div><h1 class=post-title>NET의 AES HW 가속 지원</h1><div class=post-meta><span title='2022-03-03 01:24:30 +0900 KST'>2022/03/03</span>&nbsp;·&nbsp;628 words&nbsp;·&nbsp;Seunghwan Chun</div></header><div class=post-content><h1 id=목적>목적<a hidden class=anchor aria-hidden=true href=#목적>#</a></h1><p><a href=https://en.wikipedia.org/wiki/Advanced_Encryption_Standard>AES 대칭키 알고리즘</a>은 아키텍처에서 <a href=https://en.wikipedia.org/wiki/AES_instruction_set>AES-NI</a>와 같은 HW 가속 instruction set을 제공하기도 한다.</p><p>라이브러리에서 AES 가속을 지원한다면 프로그램의 수행속도를 줄일 수 있다.</p><p>검색 결과 AesManaged는 AES HW 가속을 지원하고 AesCryptoServiceProvider 클래스는 AES 가속을 지원하지 않는 것을 확인해 확인하기 위해 간단한 테스트를 하였다.</p><h1 id=가설>가설<a hidden class=anchor aria-hidden=true href=#가설>#</a></h1><ul><li>AES의 HW 가속은 순수 SW 연산보다 현저히 빠를 것이다.</li><li>.NET에서 AesCryptoServiceProvider class는 HW 가속을 지원하며 AesManaged class는 지원하지 않을 것이다.</li><li>작은 크기의 많은 AES 연산에서는 overhead로 HW 가속이 더 느릴수 있다.</li></ul><h1 id=net-48-4kb-x-100000-aes-encryption>.NET 4.8, 4KB x 100000 AES encryption<a hidden class=anchor aria-hidden=true href=#net-48-4kb-x-100000-aes-encryption>#</a></h1><p>작은 크기에 큰 반복 횟수에서는 AesManaged가 더 빠른 결과를 보였다.</p><table><thead><tr><th style=text-align:center>.NET 4.8</th><th style=text-align:center>1(ms)</th><th style=text-align:center>2</th><th style=text-align:center>3</th><th style=text-align:center>4</th><th style=text-align:center>5</th></tr></thead><tbody><tr><td style=text-align:center>AesManaged</td><td style=text-align:center>4968</td><td style=text-align:center>4940</td><td style=text-align:center>4947</td><td style=text-align:center>4971</td><td style=text-align:center>4939</td></tr><tr><td style=text-align:center>AesCryptoServiceProvider</td><td style=text-align:center>6395</td><td style=text-align:center>6407</td><td style=text-align:center>6399</td><td style=text-align:center>6323</td><td style=text-align:center>6322</td></tr></tbody></table><h1 id=net-48-1mb-x-1000-aes-encryption>.NET 4.8, 1MB x 1000 AES encryption<a hidden class=anchor aria-hidden=true href=#net-48-1mb-x-1000-aes-encryption>#</a></h1><p>큰 크기에 낮은 반복 횟수의 암호화는 AES 가속이 되는 AesCryptoServiceProvider 클래스가 월등히 유리하다. 클래스만 변경했을 때 12배 이상 차이가 나는 것을 확인했다.</p><table><thead><tr><th style=text-align:center>.NET 4.8</th><th style=text-align:center>1(ms)</th><th style=text-align:center>2</th><th style=text-align:center>3</th><th style=text-align:center>4</th><th style=text-align:center>5</th></tr></thead><tbody><tr><td style=text-align:center>AesCryptoServiceProvider</td><td style=text-align:center>1004</td><td style=text-align:center>983</td><td style=text-align:center>984</td><td style=text-align:center>987</td><td style=text-align:center>984</td></tr><tr><td style=text-align:center>AesManaged</td><td style=text-align:center>12468</td><td style=text-align:center>12671</td><td style=text-align:center>12436</td><td style=text-align:center>12483</td><td style=text-align:center>12436</td></tr></tbody></table><h1 id=code>Code<a hidden class=anchor aria-hidden=true href=#code>#</a></h1><script type=text/javascript src=https://gist.github.com/c9f8584e2bd2bee982e54a9bad2deb55.js></script><h1 id=linux--openssl>Linux & OpenSSL<a hidden class=anchor aria-hidden=true href=#linux--openssl>#</a></h1><p>리눅스 에서는 openssl cli로 HW 가속을 테스트할 수 있다.</p><p>가능한 경우 EVP_ 접두사 함수들은 기본적으로 AES-NI 를 사용하며 AES_ 접두사 함수들은 사용하지 않는다.</p><p>64바이트 이상에서 속도가 3배 이상 차이나는 것을 확인할 수 있다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>$ openssl speed -elapsed -evp aes-128-cbc
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>type             <span style=color:#ae81ff>16</span> bytes     <span style=color:#ae81ff>64</span> bytes    <span style=color:#ae81ff>256</span> bytes   <span style=color:#ae81ff>1024</span> bytes   <span style=color:#ae81ff>8192</span> bytes  <span style=color:#ae81ff>16384</span> bytes
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>aes-128-cbc     879157.61k  1346181.01k  1409330.52k  1448567.47k  1479671.81k  1460371.46k
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>$ OPENSSL_ia32cap<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;~0x200000200000000&#34;</span> openssl speed -elapsed -evp aes-128-cbc
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>type             <span style=color:#ae81ff>16</span> bytes     <span style=color:#ae81ff>64</span> bytes    <span style=color:#ae81ff>256</span> bytes   <span style=color:#ae81ff>1024</span> bytes   <span style=color:#ae81ff>8192</span> bytes  <span style=color:#ae81ff>16384</span> bytes
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>aes-128-cbc     409826.10k   425150.51k   428506.71k   429743.79k   429782.36k   429725.01k
</span></span></code></pre></div><h1 id=결론>결론<a hidden class=anchor aria-hidden=true href=#결론>#</a></h1><ul><li>.NET 4.8 에서는 AesCryptoServiceProvider 쪽을 사용하는 것이 대개의 경우 더 유리하다.</li><li>.NET 6.0도 테스트했지만 두 클래스의 속도가 400-600ms로 비슷한 결과가 나왔다. 6.0에서는 AesCryptoServiceProvider 클래스도 HW 가속을 지원하는 것이 아닐까 추측한다.</li></ul><h1 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h1><ul><li><a href=https://www.codeproject.com/Tips/844795/Measuring-the-performance-of-AES-implementations-i>https://www.codeproject.com/Tips/844795/Measuring-the-performance-of-AES-implementations-i</a></li><li><a href=https://odetocode.com/blogs/scott/archive/2014/02/24/symmetric-encryption-benchmarks-with-c.aspx>https://odetocode.com/blogs/scott/archive/2014/02/24/symmetric-encryption-benchmarks-with-c.aspx</a></li><li><a href=https://stackoverflow.com/questions/23444135/is-net-aesmanaged-cryptography-hardware-accelerated>https://stackoverflow.com/questions/23444135/is-net-aesmanaged-cryptography-hardware-accelerated</a></li><li><a href=https://stackoverflow.com/questions/25284119/how-can-i-check-if-openssl-is-support-use-the-intel-aes-ni>https://stackoverflow.com/questions/25284119/how-can-i-check-if-openssl-is-support-use-the-intel-aes-ni</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://zshchun.github.io/tags/c#/>c#</a></li><li><a href=https://zshchun.github.io/tags/crypto/>crypto</a></li></ul><nav class=paginav><a class=prev href=https://zshchun.github.io/posts/windows-terminal-input-shift-enter/><span class=title>« Prev</span><br><span>Windows Terminal+WSL2 에서 shift-enter 입력방법</span></a>
<a class=next href=https://zshchun.github.io/posts/comparison-of-decompression/><span class=title>Next »</span><br><span>Text 압축 해제 속도 비교</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://zshchun.github.io/>sh</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>